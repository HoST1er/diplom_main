{% load static %}
{% include 'main/layout.html' %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Типовые контрольные задания</title>
    <style>
        .features1 {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #fff;
            width: 100%;
            margin: 0 auto;
        }

        table {
            width: 150%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        th, td {
            border: 2px solid white;
            padding: 10px;
            text-align: left;
            color: white;
            word-wrap: break-word;
            white-space: normal;
            vertical-align: top;
        }

        th {
            background-color: #2c2c2c;
        }

        .profile-header {
            font-weight: bold;
            text-align: left;
            background-color: #2c2c2c;
            color: white;
        }

        .add-button, .remove-button {
            padding: 5px;
            margin-left: 5px;
            color: white;
            border: none;
            cursor: pointer;
            width: 30px;
        }

        .add-button {
            background-color: #4CAF50;
        }

        .remove-button {
            background-color: #ff4d4d;
        }

        .submit-button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
        }

        .submit-button:hover {
            background-color: #0056b3;
        }

        .input-row {
            display: flex;
            flex-direction: column;
        }

        .input-row input {
            margin: 5px 0;
            width: 100%;
        }
    </style>
</head>
<body>

<form method="POST" id="controlTasksForm">
    {% csrf_token %}
    <div class="features1">
        <h1>Типовые контрольные задания</h1>
        <table>
            <thead>
                <tr>
                    <th>Наименование компетенции</th>
                    <th>Индикаторы достижения компетенции</th>
                    <th>Результаты обучения (умения и знания)</th>
                    <th>Типовые контрольные задания</th>
                </tr>
            </thead>
            <tbody>
                {% for profile, competencies in competencies_by_profile.items %}
                    <tr>
                        <td colspan="4" class="profile-header">Для профиля {{ profile }}</td>
                    </tr>
                    {% with last_competence_code=None %}
                    {% for competence in competencies %}
                        {% with last_indicator=None %}
                        {% for indicator_tuple in competence.indicators_with_know_do %}
                            {% with indicator=indicator_tuple.0 know=indicator_tuple.1 do=indicator_tuple.2 %}
                                <tr>
                                    {% if competence.competence_code != last_competence_code %}
                                        <td rowspan="{% for comp in competencies %}{% if comp.competence_code == competence.competence_code %}1{% endif %}{% endfor %}">{{ competence.competence_code }}<br>{{ competence.competence_name }}</td>
                                    {% else %}
                                        <td></td>
                                    {% endif %}
                                    <td>{{ indicator }}</td>
                                    <td>
                                        <div><strong>Знания:</strong> {{ know }}</div>
                                        <div><strong>Умения:</strong> {{ do }}</div>
                                    </td>
                                    <td>
                                        <div class="input-row">
                                            <input type="text" name="task_{{ competence.competence_code }}_{{ forloop.counter0 }}" />
                                            <button type="button" class="add-button" onclick="addInputBox(this)">+</button>
                                            <button type="button" class="remove-button" onclick="removeInputBox(this)">-</button>
                                        </div>
                                        <input type="hidden" id="competence_name_{{ competence.competence_code }}" value="{{ competence.competence_name }}" />
                                        <input type="hidden" id="indicator_{{ competence.competence_code }}_{{ forloop.counter0 }}" value="{{ indicator }}" />
                                        <input type="hidden" id="know_{{ competence.competence_code }}_{{ forloop.counter0 }}" value="{{ know }}" />
                                        <input type="hidden" id="do_value_{{ competence.competence_code }}_{{ forloop.counter0 }}" value="{{ do }}" />
                                    </td>
                                </tr>
                                {% with last_competence_code=competence.competence_code %}
                                {% endwith %}
                            {% endwith %}
                        {% endfor %}
                        {% endwith %}
                    {% endfor %}
                    {% endwith %}
                {% endfor %}
            </tbody>
        </table>
    </div>

    <button type="submit" class="submit-button">Далее</button>
</form>

<script>
    function addInputBox(button) {
        const row = button.closest('.input-row');
        const newInput = document.createElement('input');
        newInput.setAttribute('type', 'text');
        newInput.setAttribute('name', row.querySelector('input[type="text"]').name);
        row.insertBefore(newInput, button);
    }

    function removeInputBox(button) {
        const row = button.closest('.input-row');
        const inputs = row.querySelectorAll('input[type="text"]');
        if (inputs.length > 1) {
            row.removeChild(inputs[inputs.length - 1]);
        }
    }

    document.getElementById("controlTasksForm").onsubmit = function(event) {
        event.preventDefault();

        const form = event.target;
        const inputElements = form.querySelectorAll('input[name^="task_"]');
        const controlTasks = [];

        inputElements.forEach(input => {
            const nameParts = input.name.split('_');
            if (nameParts.length < 3) return;

            const competenceCode = nameParts[1];
            const taskIndex = nameParts[2];

            const indicatorElement = document.querySelector(#indicator_${competenceCode}_${taskIndex});
            const knowElement = document.querySelector(#know_${competenceCode}_${taskIndex});
            const doValueElement = document.querySelector(#do_value_${competenceCode}_${taskIndex});
            const competenceNameElement = document.querySelector(#competence_name_${competenceCode});

            const indicator = indicatorElement?.value || '';
            const know = knowElement?.value || '';
            const doValue = doValueElement?.value || '';
            const competenceName = competenceNameElement?.value || '';

            let profile = '';
            let currentRow = input.closest('tr');
            while (currentRow && !profile) {
                const profileRow = currentRow.previousElementSibling;
                if (profileRow && profileRow.children.length === 1 && profileRow.children[0].textContent.includes('Для профиля «')) {
                    profile = profileRow.children[0].textContent.replace('Для профиля «', '').replace('»', '').trim();
                    break;
                }
                currentRow = profileRow;
            }

            let existingEntry = controlTasks.find(task =>
                task.profile === profile &&
                task.competence_code === competenceCode &&
                task.indicator === indicator
            );

            if (existingEntry) {
                existingEntry.task.push(input.value);
            } else {
                controlTasks.push({
                    profile: profile,
                    competence_code: competenceCode,
                    competence_name: competenceName,
                    indicator: indicator,
                    know: know,
                    do_value: doValue,
                    task: [input.value]
                });
            }
        });

        fetch("{% url 'save_user_data7' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ control_tasks: controlTasks })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                window.location.href = "{% url 'example_quest_to_test' %}";
            } else {
                alert('Ошибка при сохранении данных: ' + (data.message || ''));
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Ошибка при отправке данных');
        });
    };
</script>

</body>
</html>